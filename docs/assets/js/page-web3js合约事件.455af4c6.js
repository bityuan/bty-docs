(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{655:function(s,n,a){"use strict";a.r(n);var e=a(1),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"web3-js-合约事件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#web3-js-合约事件"}},[s._v("#")]),s._v(" web3.js 合约事件")]),s._v(" "),a("p",[s._v("事件是 Solidity 合约中的一种通信机制，它允许合约在执行过程中发出通知，以便应用程序或其他合约可以监听这些通知并采取相应的行动。")]),s._v(" "),a("p",[s._v("事件通常用于以下情况：")]),s._v(" "),a("ol",[a("li",[s._v("交易完成后向外部系统发送通知。")]),s._v(" "),a("li",[s._v("监听合约状态变化，例如合约中某个值的更新。")]),s._v(" "),a("li",[s._v("记录合约的行为，以便后续分析或审计。")])]),s._v(" "),a("p",[s._v("以前面介绍的 NFT 合约为例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('event TokenMinted(uint256 indexed tokenId, uint256 supply, string uri);\n\nfunction mint(uint256 tokenId, uint256 supply, string memory uri) public onlyOwner {\n        _mint(msg.sender, tokenId, supply, "");\n        _tokenSupply[tokenId] += supply;\n        _tokenURIs[tokenId] = uri;\n        emit TokenMinted(tokenId, supply, uri);\n    }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("在上面的代码中，TokenMinted 事件用于记录 mint 函数中的值更改，并向应用程序发出通知。indexed 关键字用于指定事件参数在事件日志中进行索引，这使得应用程序可以更轻松地搜索和过滤事件日志。")]),s._v(" "),a("p",[s._v("通过监听事件，应用程序可以自动更新状态或响应合约的状态变化，这使得合约更加灵活和可扩展。")]),s._v(" "),a("h3",{attrs:{id:"_1-查询合约历史事件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-查询合约历史事件"}},[s._v("#")]),s._v(" 1. 查询合约历史事件")]),s._v(" "),a("p",[s._v("web3.eth.getPastLogs()"),a("br"),s._v("\n过滤器对象：")]),s._v(" "),a("ul",[a("li",[s._v("fromBlock: 起始区块（最小值支持从 1 开始）")]),s._v(" "),a("li",[s._v("toBlock: 终止区块， 这个参数不带代表一直到最大区块")]),s._v(" "),a("li",[s._v("address: 合约地址")]),s._v(" "),a("li",[s._v("topics: 日志项中的主题值数组")])]),s._v(" "),a("p",[s._v("示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("web3.eth.getPastLogs({\n    address: contractAddress,\n    topics: ['0x30b042f6d29a39b7c10c2dfbd81016db37ea3d11e72ec5764fb0d0f7a1012a3a'],\n    fromBlock: 71,\n})\n.then(console.log);\n\n[\n  {\n    address: '0x61b35E8804F87589fBb7da3A6B68c563C05Bb2f1',\n    topics: [\n      '0x30b042f6d29a39b7c10c2dfbd81016db37ea3d11e72ec5764fb0d0f7a1012a3a',\n      '0x0000000000000000000000000000000000000000000000000000000000002718'\n    ],\n    data: '........',\n    blockNumber: 79,\n    transactionHash: '0xc5bb3cd573e04e5561d262c394218bc3ad3457f6f0aa2f8101464ebb108700fb',\n    transactionIndex: 0,\n    blockHash: '0x7b0b108c8b55bdefb5edd6a1ce1ec05180f3cd0b58aa373ff88e9682ab694b7a',\n    logIndex: 1,\n    removed: false,\n    id: 'log_bab13c4d'\n  }\n]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("h3",{attrs:{id:"_2-订阅区块链中的指定事件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-订阅区块链中的指定事件"}},[s._v("#")]),s._v(" 2. 订阅区块链中的指定事件")]),s._v(" "),a("p",[s._v("web3.eth.subscribe(type [, options] [, callback]);")]),s._v(" "),a("ul",[a("li",[s._v("String - 订阅类型")]),s._v(" "),a("li",[s._v("Mixed - (可选) 依赖于订阅类型的可选额外参数")]),s._v(" "),a("li",[s._v("Function - (可选) 可选的回调函数，其第一个参数为错误对象，第二个参数为结果")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("web3.eth.subscribe('logs', {\n    address: contractAddress,\n    topics: ['0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62'],\n}, function(error, result) {\n    if (!error) {\n        console.log(result);\n    } else {\n        console.error(error)\n    }\n})\n.on(\"connected\", subscriptionId => {\n    console.log(`Subscribed with ID: ${subscriptionId}`);\n  });\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"_3-根据事件签名计算-topics-的值"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-根据事件签名计算-topics-的值"}},[s._v("#")]),s._v(" 3. 根据事件签名计算 topics 的值")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("var eventName = 'TokenMinted(uint256,uint256,string)'\nvar topic = web3.eth.abi.encodeEventSignature(eventName)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);
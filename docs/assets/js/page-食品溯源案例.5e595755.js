(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{645:function(a,t,s){"use strict";s.r(t);var e=s(1),n=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"食品溯源案例"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#食品溯源案例"}},[a._v("#")]),a._v(" 食品溯源案例")]),a._v(" "),s("blockquote",[s("p",[a._v("下面以基于Solidity语言的食品溯源智能合约，阐述如何在chain33平行链上设计，实现，部署和调用智能合约。")])]),a._v(" "),s("h2",{attrs:{id:"_1-平行链环境搭建及运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-平行链环境搭建及运行"}},[a._v("#")]),a._v(" 1 平行链环境搭建及运行")]),a._v(" "),s("p",[a._v("具体过程参见 "),s("a",{attrs:{href:"https://docs.bityuan.com/zh/guide/1.%E5%85%A5%E9%97%A8/2.%20Build%20parachain/",target:"_blank",rel:"noopener noreferrer"}},[a._v("平行链环境搭建"),s("OutboundLink")],1),a._v("， 如果环境已经具备，则跳过这一步。")]),a._v(" "),s("p",[s("strong",[a._v("创建钱包并导入创世地址私钥")])]),a._v(" "),s("p",[a._v("已经创建钱包的话就无需进行这一步了。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('生成随机数种子，建议可以手工生成并保存好，后继可以使用此种子恢复钱包，--rpc_laddr参数可以设定指向具体链的rpc地址（以下地址只是举例，需要根据自己实际监听的jrpc地址修改==>对应配置文件中的：jrpcBindAddr配置项）  \n./chain33-cli --rpc_laddr="http://localhost:8901"  seed generate -l 0\n//保存种子，并设置钱包密码为"fzm12345"，注意：密码可以自定义(8位以上，字母+数字)，并且牢牢记住，后面解锁钱包时会用到  \n./chain33-cli --rpc_laddr="http://localhost:8901"  seed save -p fzm12345 -s "上一步中生成的seed"\n//使用我们刚刚设置的密码解锁钱包（钱包新创建后默认为锁定状态），-t后跟的是自动锁定的时间，0代表永不锁定（重启例外）\n./chain33-cli --rpc_laddr="http://localhost:8901"  wallet unlock -p fzm12345 -t 0 \n//检查钱包的状态 \n./chain33-cli --rpc_laddr="http://localhost:8901"  wallet status\n./chain33-cli创建一个账户地址和私钥  \n./chain33-cli --rpc_laddr="http://localhost:8901"  account create -l testEvm\n//查询上述被创建账户的地址和私钥  \n./chain33-cli --rpc_laddr="http://localhost:8901"  account dump_key -a "上一步生成的地址"\n//查看账户  \n./chain33-cli --rpc_laddr="http://localhost:8901" account list   \n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br")])]),s("p",[s("font",{attrs:{color:"red"}},[a._v("注意：")]),a._v("平行链节点执行指令时，需要添加"),s("code",[a._v("--rpc_laddr")]),a._v("，rpc_laddr表示平行链节点启动的IP和监听端口，如果不指定这个参数，默认是指向"),s("code",[a._v("http://localhost:8801")]),a._v(" (如果主链节点和平行链节点在同一台机器上，且主链端口是8801，那么不指定rpc_laddr，命令就可能会跑错链)。")],1),a._v(" "),s("p",[s("strong",[a._v("查看平行链上区块同步的状态")])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('./chain33-cli --rpc_laddr="http://localhost:8901"  block last_header\n{\n    "version": 0,\n    "parentHash": "0x905d3c3ab62718381436720382e436a52976b6798896c77c97cb4e751e3a67c9",\n    "txHash": "0x765a8babc9b63f7a5c608afb0943001741f3591f676026cd67dd99f6b3ad5122",\n    "stateHash": "0xeb240fe1248028e9c7271ae2838ea3970bb880031764c8154c8bce2d16262cb7",\n    "height": 57,\n    "blockTime": 1546501778,\n    "txCount": 1,\n    "hash": "0xac2be112305b231b9851a34f6db7bde1745a2b7c9c3a684c736dc59baf3e6e51",\n    "difficulty": 0\n}\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("h2",{attrs:{id:"_2-合约设计"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-合约设计"}},[a._v("#")]),a._v(" 2 合约设计")]),a._v(" "),s("p",[a._v("针对食品溯源这一场景，设计一个合约，实现产地，生产，流通等环节溯源, 合约满足以下几个特性。")]),a._v(" "),s("p",[a._v("实际溯源的环节是一个非常复杂的过程，这边精简为几个环节： 农牧场，食品厂，超市，食品质检部门，用户产品具备的属性，以生猪为例各环节操作：")]),a._v(" "),s("ol",[s("li",[a._v("支持添加生猪信息，修改生猪信息。")]),a._v(" "),s("li",[a._v("支持添加质检信息。")]),a._v(" "),s("li",[a._v("支持添加超时上架信息。")]),a._v(" "),s("li",[a._v("支持添加用户评分信息。")]),a._v(" "),s("li",[a._v("支持上述信息的查询。")])]),a._v(" "),s("p",[a._v("合约代码参见："),s("a",{attrs:{href:"https://bty33.oss-cn-shanghai.aliyuncs.com/chain33Dev/solidity/Food.zip",target:"_blank",rel:"noopener noreferrer"}},[a._v("智能合约代码下载"),s("OutboundLink")],1)]),a._v(" "),s("h2",{attrs:{id:"_3-合约编译"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-合约编译"}},[a._v("#")]),a._v(" 3 合约编译")]),a._v(" "),s("p",[a._v("下载解压并编译上述智能合约，参见"),s("a",{attrs:{href:"https://baas.33.cn/doc/detail/154",target:"_blank",rel:"noopener noreferrer"}},[a._v("ChainIDE配置与使用"),s("OutboundLink")],1),a._v("。")]),a._v(" "),s("p",[a._v("获取合约的bytecode和abi:"),s("br"),a._v("\nbytecode: 60806040526000805560006001556000....省略后面部分，从IDE上拷贝..."),s("br"),a._v('\nabi: [{"inputs":[{"internalType":"address","name":"_creator","type":"address"}....省略后面部分，从IDE上拷贝.....')]),a._v(" "),s("h2",{attrs:{id:"_4-合约部署和调用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-合约部署和调用"}},[a._v("#")]),a._v(" 4 合约部署和调用")]),a._v(" "),s("p",[a._v("部署和调用合约的命令行参数参见"),s("a",{attrs:{href:"https://docs.bityuan.com/zh/guide/1.%E5%85%A5%E9%97%A8/7.%20Deploy%20smart%20contract/",target:"_blank",rel:"noopener noreferrer"}},[a._v("EVM合约部署"),s("OutboundLink")],1),a._v("。")]),a._v(" "),s("h3",{attrs:{id:"_4-1-合约部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-合约部署"}},[a._v("#")]),a._v(" 4.1 合约部署")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('//构造合约部署交易, --user.p.mbaas. 是平行链的title，此参数一定要填对，不然平行链上无法收到交易\n./chain33-cli --rpc_laddr="http://localhost:8901" --paraName="user.p.mbaas." evm create -s foodTest -f 1000000 -c 上述btyecode值 \n//签名交易 -k：合约部署人的私钥(此私钥匙对应的地址是： 1LQJbjsNxh6ve6RCXBuDnUuMQsqXsc4cWK，  此地址在下面计算合约地址时会用到)\n./chain33-cli --rpc_laddr="http://localhost:8901" wallet sign -k 0xdb9415dfbd54ed84dccde80a0f9f2497c7b967116da92d8682900b324ea33d68 -d 上一步返回的数据\n//发送交易（返回的hash要记住，下面计算合约地址的时候会用到）\n./chain33-cli --rpc_laddr="http://localhost:8901" wallet send -d 上一步签过名的数据\n//查询交易（在结果中 "receipt": {"ty": 2,"tyName": "ExecOk".....} 代表交易执行成功，如果ty=1,代表交易只是被打包但执行失败）\n./chain33-cli --rpc_laddr="http://localhost:8901" tx query_hash -s 上一步返回的hash\n//如果上述交易执行返回ExecOk,代表合约部署成功，计算此合约的地址, --user.p.mbaas. 是平行链的title，此参数一定要填对 -a 合约部署人的地址 -s 上一步返回的hash(去掉前面0x的值)，假设此处返回的是：174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4\n./chain33-cli --rpc_laddr="http://localhost:8901" --paraName="user.p.mbaas." evm calc -a 1LQJbjsNxh6ve6RCXBuDnUuMQsqXsc4cWK -s 上一步返回的hash去掉最前面的0x\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br")])]),s("h3",{attrs:{id:"_4-2-信息录入"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-信息录入"}},[a._v("#")]),a._v(" 4.2 信息录入")]),a._v(" "),s("h4",{attrs:{id:"_4-2-1-添加猪肉信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-添加猪肉信息"}},[a._v("#")]),a._v(" 4.2.1 添加猪肉信息")]),a._v(" "),s("p",[a._v("农牧场出栏")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("出栏批次")]),a._v(" "),s("th",[a._v("名称")]),a._v(" "),s("th",[a._v("重量")]),a._v(" "),s("th",[a._v("出栏日期")]),a._v(" "),s("th",[a._v("产地")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("00001")]),a._v(" "),s("td",[a._v("pig001")]),a._v(" "),s("td",[a._v("500")]),a._v(" "),s("td",[a._v("20190221")]),a._v(" "),s("td",[a._v("NanJing")])])])]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('//使用addPigInfo进行猪肉信息的录入  \n//重要： 先在本地生成一个174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4.abi文件，复制IDE中生成的abi内容到此文件中  \n//其中174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4替换成自己的合约地址    \n./chain33-cli --rpc_laddr="http://localhost:8901" --paraName="user.p.mbaas." evm call -e 174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4 -p "addPigInfo("1CbEVT9RnM5oZhWMj4fxUrJX94VtRotzvs","pig001","00001","500","20190210","NanJing")"    \n//-k是调用合约人的私钥  \n./chain33-cli --rpc_laddr="http://localhost:8901" wallet sign -k 0xdb9415dfbd54ed84dccde80a0f9f2497c7b967116da92d8682900b324ea33d68 -d 上一步返回的结果  \n./chain33-cli --rpc_laddr="http://localhost:8901" wallet send -d 上一步返回的结果    \n//通过hash查看猪肉信息是否成功添加，如果返回"receipt": {"ty": 2,"tyName": "ExecOk".....} 代表交易执行成功，如果ty=1,代表交易只是被打包但执行失败）  \n./chain33-cli --rpc_laddr="http://localhost:8901" tx query -s "上一步返回的hash"  \n使用getPigNumber()函数查看录入了多少条生猪信息  \n其中-a 174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4替换成合约地址，-c为调用人地址，-b为合约中查询方法  \n./chain33-cli --rpc_laddr="http://localhost:8801" --paraName="user.p.mbaas." evm query -a  174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4 -c 1LQJbjsNxh6ve6RCXBuDnUuMQsqXsc4cWK -b "getPigNumber()"  \n通过getPigInfoByIndex函数，查询index对应的生猪详细信息  \n./chain33-cli --rpc_laddr="http://localhost:8801" --paraName="user.p.mbaas." evm query -a  174dwVy4fEY7WQkpuRZRci88BE5iuHHSY4 -c 1LQJbjsNxh6ve6RCXBuDnUuMQsqXsc4cWK -b "getPigInfoByIndex(0)"  \n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br")])]),s("h4",{attrs:{id:"_4-2-2-添加食品信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-添加食品信息"}},[a._v("#")]),a._v(" 4.2.2 添加食品信息")]),a._v(" "),s("p",[a._v("食品厂生产（比如火腿)")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("食品编号(比如二维码)")]),a._v(" "),s("th",[a._v("名称")]),a._v(" "),s("th",[a._v("重量")]),a._v(" "),s("th",[a._v("生产日期")]),a._v(" "),s("th",[a._v("包装日期")]),a._v(" "),s("th",[a._v("保质期")]),a._v(" "),s("th",[a._v("猪肉出栏批次")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("001")]),a._v(" "),s("td",[a._v("food001")]),a._v(" "),s("td",[a._v("500")]),a._v(" "),s("td",[a._v("20190215")]),a._v(" "),s("td",[a._v("20190220")]),a._v(" "),s("td",[a._v("20210215")]),a._v(" "),s("td",[a._v("00001")])])])]),a._v(" "),s("p",[a._v("上链和查询脚本和4.2.1中类似(具体方法名称和参数，请见Food.sol中定义)。")]),a._v(" "),s("h4",{attrs:{id:"_4-2-3-添加质检信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3-添加质检信息"}},[a._v("#")]),a._v(" 4.2.3 添加质检信息")]),a._v(" "),s("p",[a._v("食品质检部门抽检")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("食品编号(比如二维码)")]),a._v(" "),s("th",[a._v("检测时间")]),a._v(" "),s("th",[a._v("检测结果")]),a._v(" "),s("th",[a._v("检测说明")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("food001")]),a._v(" "),s("td",[a._v("20190226")]),a._v(" "),s("td",[a._v("Qualified")]),a._v(" "),s("td",[a._v("The food is good.")])])])]),a._v(" "),s("p",[a._v("上链和查询脚本和4.2.1中类似(具体方法名称和参数，请见Food.sol中定义)。")]),a._v(" "),s("h4",{attrs:{id:"_4-2-4-添加超市上架信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-4-添加超市上架信息"}},[a._v("#")]),a._v(" 4.2.4 添加超市上架信息")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("食品编号(比如二维码)")]),a._v(" "),s("th",[a._v("上架日期")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("food001")]),a._v(" "),s("td",[a._v("20190304")])])])]),a._v(" "),s("p",[a._v("上链和查询脚本和4.2.1中类似(具体方法名称和参数，请见Food.sol中定义)。")]),a._v(" "),s("h4",{attrs:{id:"_4-2-5-添加用户评分信息"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-5-添加用户评分信息"}},[a._v("#")]),a._v(" 4.2.5 添加用户评分信息")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("食品编号")]),a._v(" "),s("th",[a._v("用户评分")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("food001")]),a._v(" "),s("td",[a._v("90")])])])]),a._v(" "),s("p",[a._v("上链和查询脚本和4.2.1中类似(具体方法名称和参数，请见Food.sol中定义)。")])])}),[],!1,null,null,null);t.default=n.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{235:function(t,a,e){t.exports=e.p+"assets/img/Storage_template_interaction.b7b85799.png"},236:function(t,a,e){t.exports=e.p+"assets/img/KVDB_Architecture.2ac6b472.png"},237:function(t,a,e){t.exports=e.p+"assets/img/goleveldb_Architecture.6013bca4.png"},238:function(t,a,e){t.exports=e.p+"assets/img/LocalDB_Architecture.21244727.png"},239:function(t,a,e){t.exports=e.p+"assets/img/statedb_Architecture.211d68a6.png"},240:function(t,a,e){t.exports=e.p+"assets/img/store_Architecture.a53f6aac.png"},511:function(t,a,e){"use strict";e.r(a);var s=e(1),n=Object(s.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"storage-module"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#storage-module"}},[t._v("#")]),t._v(" Storage Module")]),t._v(" "),s("blockquote",[s("p",[t._v("比特元底层Chain33使用高性能、高可靠的KV数据库来进行区块链数据的存储，支持goleveldb、gobadgerdb、gomemdb、gossdb等KV数据库类型。区块链中的状态数据的的存储格式采用可配置、可插拔的方式，可以支持mavl、mpt、kvmvcc的存储格式。")])]),t._v(" "),s("h2",{attrs:{id:"module-introduction"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#module-introduction"}},[t._v("#")]),t._v(" Module Introduction")]),t._v(" "),s("p",[t._v("Like the traditional blockchain implementation, chain33 uses the high performance and high reliability KV DB for data storage, and the DB interfaces provided by design are all defined for KV storage characteristics.")]),t._v(" "),s("p",[t._v("On the chain33 system, there are currently four database instances, as follows:")]),t._v(" "),s("blockquote",[s("p",[t._v("fzm@fzm001:~/chain33 $ ls datadir"),s("br"),t._v("\naddrbook blockchain.db mavltree wallet")])]),t._v(" "),s("p",[t._v("In Which:")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("addrbook")]),t._v(": The implementation capability is relatively single, mainly storing P2P nodes and related state information.")]),t._v(" "),s("li",[s("strong",[t._v("wallet")]),t._v(": Store local account information")]),t._v(" "),s("li",[s("strong",[t._v("blockchain.db")]),t._v(": Store the block header, block body, and additional information about the block, and the result information returned by the local execution of the transaction.")]),t._v(" "),s("li",[s("strong",[t._v("store")]),t._v(": Store the result of the transaction execution and the hash information of the block staus.")])]),t._v(" "),s("p",[t._v("For the storage module of chain33, there are several points:")]),t._v(" "),s("ul",[s("li",[t._v("The underlying storage and operation of chain33 supports many implementations by flexible configuration.")])]),t._v(" "),s("blockquote",[s("p",[t._v("The underlying layer can support various types of KV DB implementations based on configuration, such as goleveldb, gobadgerdb, gomemdb, gossdb, etc.\nThe underlying storage operations of the above four database instances, addrbook, wallet, blockchain.db and store, are all implemented through specific KV DB configurations, such as the default configuration of goleveldb.")])]),t._v(" "),s("ul",[s("li",[t._v("In practical application, Excutor uses two abstract database concepts, StateDB and LocalDB, to query the storage message of blockchain.db respectively.")]),t._v(" "),s("li",[t._v("Format of the data storage in Store module can also adopts configurable, pluggable way, and default support mavl tree storage format.")])]),t._v(" "),s("p",[t._v("Chain33 also supports user extension of new storage formats, such as pure KVDB storage format, mvcc-based KVDB storage format, MPT storage format, etc.")]),t._v(" "),s("p",[t._v("But, ultimately the underlying operation of the data store is implemented through the specific KV DB configuration, such as goleveldb.")]),t._v(" "),s("h2",{attrs:{id:"logical-architecture"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#logical-architecture"}},[t._v("#")]),t._v(" Logical Architecture")]),t._v(" "),s("h3",{attrs:{id:"storage-module-structure"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#storage-module-structure"}},[t._v("#")]),t._v(" Storage Module Structure")]),t._v(" "),s("p",[s("img",{attrs:{src:e(235),alt:"Storage Module Structure"}})]),t._v(" "),s("ul",[s("li",[t._v("P2P, Wallet, Blockchain and Store all involve data storage, write and read data to KV DB instance through DB interface.")]),t._v(" "),s("li",[t._v("BlockChain and Store modules also provide data query interfaces, which is operated by StateDB and LocalDB abstract database objects using messages.")]),t._v(" "),s("li",[t._v("When BlockChain module generates blocks, it can write status information to the Store module by messages.")]),t._v(" "),s("li",[t._v("Wallet, Consensus, Client and other modules can use messages to initiate data query to Blockchain and Store respectively by StateDB and LocalDB objects through the actuator.")]),t._v(" "),s("li",[t._v("The Client module can also launch a status data query directly to the Store through messages.")])]),t._v(" "),s("h3",{attrs:{id:"underlying-logical-architecture-storing-kv-db"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#underlying-logical-architecture-storing-kv-db"}},[t._v("#")]),t._v(" Underlying Logical Architecture Storing KV DB")]),t._v(" "),s("p",[s("img",{attrs:{src:e(236),alt:"Logical Architecture Storing KV DB"}})]),t._v(" "),s("p",[t._v("KV DB supported by the underlying data storage needs to adapt to the above interfaces.")]),t._v(" "),s("p",[t._v("Take goleveldb as an example:")]),t._v(" "),s("p",[s("img",{attrs:{src:e(237),alt:"goleveldb"}})]),t._v(" "),s("p",[t._v("You can see that when goleveldb implements the DB interface, Iterator interface, and Batch interface, it can be used in the chain33 system as an underlying database implementation of the Storage module.")]),t._v(" "),s("p",[t._v("Different KV DB implementations, such as gobadgerdb, gomemdb and gossdb, are all similar, need to implement db interface, Iterator interface and Batch interface to meet the needs of upper logical functions.")]),t._v(" "),s("h3",{attrs:{id:"logical-architecture-of-statedb-and-localdb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#logical-architecture-of-statedb-and-localdb"}},[t._v("#")]),t._v(" Logical Architecture of StateDB and LocalDB")]),t._v(" "),s("p",[s("img",{attrs:{src:e(238),alt:"Logical Architecture of LocalDB"}})]),t._v(" "),s("p",[s("img",{attrs:{src:e(239),alt:"Logical Architecture of StateDB"}})]),t._v(" "),s("p",[t._v("As you can see, the function of these two abstract databases is very simple. What is misleading is the usage scenario and storage content of the two DB, so the following table shows the differences between the two DBs.")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"left"}},[t._v("DB")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("StateDB")]),t._v(" "),s("th",{staticStyle:{"text-align":"left"}},[t._v("LocalDB")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("write data purpose")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("cache")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("cache")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("read data source")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("store")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("blockchain.db")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[t._v("**actuator corresponding method(data source)")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("KV returned by Exec")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("KV returned by ExecLocal")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("whether data contains status")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("yes (read and write data with StateHash)")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("no (Key index data only)")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("which data to store")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("Store the kvset for block trade execution（KV database direct storage; mavl database is stored as a StateHash construct tree）")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("all information in block")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"left"}},[s("strong",[t._v("whether to check data")])]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("yes (recalculate StateHash check when executing block)")]),t._v(" "),s("td",{staticStyle:{"text-align":"left"}},[t._v("no (write directly)")])])])]),t._v(" "),s("h3",{attrs:{id:"store-logical-architecture"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#store-logical-architecture"}},[t._v("#")]),t._v(" Store Logical Architecture")]),t._v(" "),s("p",[s("img",{attrs:{src:e(240),alt:"Store Logical Architecture"}})]),t._v(" "),s("ul",[s("li",[t._v("The Store layer determines which format the state data will be organized in in the underlying KV DB.")]),t._v(" "),s("li",[t._v("By default, the system supports the implementation of mavl tree format. By loading plug-ins, it can also support the implementation of KV DB, KV DB based on MVCC, and MPT.")]),t._v(" "),s("li",[t._v("Developers who want to extend their data organization format need to implement the SubStore interface, register it in the system, and configure it.")])]),t._v(" "),s("h2",{attrs:{id:"process-logic"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#process-logic"}},[t._v("#")]),t._v(" Process Logic")]),t._v(" "),s("h3",{attrs:{id:"main-interface-of-underlying-kv-db"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#main-interface-of-underlying-kv-db"}},[t._v("#")]),t._v(" Main Interface of Underlying KV DB")]),t._v(" "),s("h4",{attrs:{id:"basic-data-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#basic-data-interface"}},[t._v("#")]),t._v(" Basic Data Interface")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("BatchGet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("keys "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("values "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Delete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("DeleteSync")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("These are the basic read, write, and delete interfaces for data, plus the interface to close the database. Pure key-value operation, directly docking with specific database interface.")]),t._v(" "),s("p",[t._v("Some databases may not support asynchronous writes, so they have to be implemented synchronously (which has little impact on performance).")]),t._v(" "),s("h4",{attrs:{id:"range-finder-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#range-finder-interface"}},[t._v("#")]),t._v(" Range Finder Interface")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" direction "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("PrefixCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("These two interfaces need to implement the so-called prefix search. Actually, the realization of the KV, is not purely a prefix search, but a Range find, because the data KEY matching is carried out in accordance with the the Range of estimates based on the prefix search.")]),t._v(" "),s("p",[t._v("Here is an example(the search effect and * suffix fuzzy matching is the same).")]),t._v(" "),s("p",[t._v("Example1： prefix=0xab9876abcd77ff")]),t._v(" "),s("p",[t._v("At this time, the search scope is: 0xab9876abcd 77ff xxx ~ 0xab9876abcd 78ff xxx")]),t._v(" "),s("p",[t._v("Example2：prefix=0xab9876abcd77ab")]),t._v(" "),s("p",[t._v("At this time, the search scope is: 0xab9876abcd77 ab xxx ~ 0xab9876abcd77 ac xxx")]),t._v(" "),s("p",[t._v("Where count is the number of limited searches, because the number of possible matches is large, only the previous count is returned;")]),t._v(" "),s("p",[t._v("Direction is matching direction, positive direction is from start to end, and reverse direction is from end to start;")]),t._v(" "),s("p",[t._v("Special note: when count is 0 (or the PrefixCount interface), it means to return all the matching data, but in a specific database implementation, if the amount of data is too large, it can cause problems such as database hangs, network timeouts, memory overruns.\nThe safe way is to do some processing is only take a fixed number of records (such as 10,000) each time during internal search, and then search for several times, finally summarize the results.")]),t._v(" "),s("h4",{attrs:{id:"batch-data-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#batch-data-interface"}},[t._v("#")]),t._v(" Batch Data Interface")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Batch "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Delete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("You can think of this as a transactional interface that can perform multiple Set and Delete operations, and eventually a Write commit, all or none of which succeed.")]),t._v(" "),s("p",[t._v("When implementing a database, especially one that does not support native transactions, tradeoffs may be considered. Take the implementation of SSDB as an example:")]),t._v(" "),s("ul",[s("li",[t._v("When newBatch is performed, two cache objects are created to store the cache queue for modification and deletion respectively.")]),t._v(" "),s("li",[t._v("When Set operation, check whether Delete queue has corresponding Key, if so, delete it from Delete queue, and let Set operation into Set queue;")]),t._v(" "),s("li",[t._v("When Delete operation, check whether there is corresponding Key in Set queue, if so, delete from Set queue, and let Delete operation into Delete queue;")]),t._v(" "),s("li",[t._v("When writing, insert all the keys of the Delete queue in the Set queue, set Value to null, and then call batch Set interface. If fail, then return; if successful, call batch Delete interface, then return success.")])]),t._v(" "),s("p",[t._v("There are two reasons for this operation:")]),t._v(" "),s("ol",[s("li",[t._v("Normal transaction operation is to ensure the internal operation order, so when Set and Delete operation is performing, we need to check each other’s queue, to prevent the problem of Delete before Set;")]),t._v(" "),s("li",[t._v("When the transaction commits, the data to be deleted is left empty at the same time as the write operation, in order to prevent intermediate states where the write is successful but deletion fails")])]),t._v(" "),s("h4",{attrs:{id:"iterator-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#iterator-interface"}},[t._v("#")]),t._v(" Iterator Interface")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" IteratorSeeker "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Rewind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Seek")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" Iterator "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        IteratorSeeker\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Valid")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Value")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ValueCopy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br")])]),s("p",[t._v("The ability to wrap iterators in chain33, like Pointers in C or Cursors in SQL, interfaces in Iterator are easy to implement, mainly three methods in IteratorSeeker, and are difficult to implement for some databases. The following takes SSDB as an example to illustrate the implementation logic of the iterator.")]),t._v(" "),s("p",[t._v("The creation interface for the iterator is as follows:")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Iterates through all key values in the prefix range, supporting reverse and forward iteration.")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Iterator")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" reserver "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" Iterator\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("When creating an iterator, the prefix lookup capability is wrapped, and the implementation logic in SSDB is as follows:")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("Use prefix to calculate the start and end KEYs of the match;")])]),t._v(" "),s("li",[s("p",[t._v("Use the generated command keys or rkeys to find all KEYs that satisfy this prefix (paged with 1024), and wrap this information into the object Iterator;")])]),t._v(" "),s("li",[s("p",[t._v("When the Next method is executed, the cursor +1 is used to get the corresponding KEY from the cache array, and then the Get interface of DB is called to obtain the data;")]),t._v(" "),s("p",[t._v("If Cursor +1==1024, start with the last element KEY in the current cache array and continue to get the next KEY;")])]),t._v(" "),s("li",[s("p",[t._v("When the Seek method is executed, it continuously calls the pagination logic to get the KEYS, and then matches the key until it meets, or no data;")])])]),t._v(" "),s("h4",{attrs:{id:"other-specific-interfaces"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#other-specific-interfaces"}},[t._v("#")]),t._v(" Other Specific Interfaces")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Simulated transaction interface")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Begin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Rollback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Commit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("p",[t._v("The above three methods, which simulate transaction operations and are currently implemented only in StateDB, support only single-threaded memory transactions and were introduced in support of the TxGroup concept. When you add a new database implementation, you don’t need to consider support for these three interfaces. And don’t have to call these interfaces in your own code logic.")]),t._v(" "),s("h3",{attrs:{id:"the-relevant-main-interfaces-for-statedb-and-localdb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-relevant-main-interfaces-for-statedb-and-localdb"}},[t._v("#")]),t._v(" The Relevant Main Interfaces for StateDB and LocalDB")]),t._v(" "),s("h4",{attrs:{id:"the-interface-related-to-data-storage-in-the-actuator"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-interface-related-to-data-storage-in-the-actuator"}},[t._v("#")]),t._v(" The interface related to data storage in the actuator")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetStateDB")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dbm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("KV"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("SetLocalDB")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dbm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("KVDB"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" index "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Receipt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ExecLocal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" receipt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ReceiptData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" index "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LocalDBSet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ExecDelLocal")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tx "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Transaction"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" receipt "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ReceiptData"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" index "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("LocalDBSet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("h5",{attrs:{id:"exec"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#exec"}},[t._v("#")]),t._v(" Exec")]),t._v(" "),s("p",[t._v("The specific execution logic of the transaction, no matter what logic is executed, will eventually return a *types.receipt object containing two parts, KV and Logs, where KV will be written to StateDB ("),s("font",{attrs:{color:"red"}},[t._v("finally written to store")]),t._v("), and Logs will be passed as an input parameter when ExecLocal is called;")],1),t._v(" "),s("p",[t._v("The default Exec method does not generate any data;")]),t._v(" "),s("h5",{attrs:{id:"execlocal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#execlocal"}},[t._v("#")]),t._v(" ExecLocal")]),t._v(" "),s("p",[t._v("The local execution logic of the transaction is an additional logic. And different execution results will not lead to block execution failure. The main logic here is using information generated by Exec, regenerate some additional information, convenient for other places to use;")]),t._v(" "),s("p",[t._v("The default ExecLocal method generates the transaction details data corresponding to the transaction hash;")]),t._v(" "),s("p",[s("font",{attrs:{color:"red"}},[t._v("related data will eventually be written to blockchain.db.")])],1),t._v(" "),s("h5",{attrs:{id:"execdellocal"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#execdellocal"}},[t._v("#")]),t._v(" ExecDelLocal")]),t._v(" "),s("p",[t._v("This method corresponds to ExecDelLocal, which is called when dealing with forks. If one block has been executed and then another chain becomes the main chain, then the executed block will be pushed back and the logic of ExecDelLocal will be invoked. It should rollback data written to ExecLocal.")]),t._v(" "),s("h4",{attrs:{id:"the-main-interface-for-statedb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-main-interface-for-statedb"}},[t._v("#")]),t._v(" The Main Interface for StateDB")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Get the status data from the Store (corresponding to the Store in chapter 1) through the message EventStoreGet.")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h4",{attrs:{id:"the-main-interface-for-localdb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-main-interface-for-localdb"}},[t._v("#")]),t._v(" The Main Interface for LocalDB")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Get block data from the BlockStore database (corresponding to blockchain.db in chapter 1) via the message EventLocalGet.")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  \n\n     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Query the list of data from the BlockStore database (corresponding to blockchain.db in chapter 1) via the message EventLocalList")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" direction "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  \n\n     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Query the number of keys with the specified prefix from the BlockStore database (corresponding to blockchain.db in chapter 1) via the message EventLocalPrefixCount.")]),t._v("\n     "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("PrefixCount")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prefix "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int64")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("h3",{attrs:{id:"the-main-interface-for-substore"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-main-interface-for-substore"}},[t._v("#")]),t._v(" The Main Interface for SubStore")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" SubStore "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Write KV information to the corresponding StateHash.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("datas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StoreSet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sync "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//Get KV information corresponding to StateHash.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("datas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StoreGet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//When a Blockchain module generates a block,  set the corresponding KVSet corresponding to StateHash into memory.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("MemSet")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("datas "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StoreSet"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" sync "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//When a Blockchain module generates a block,  set the corresponding KVSet corresponding to StateHash into memory.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Commit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("hash "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ReqHash"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//When a Blockchain module generates a block, write the corresponding memory KVSet for StateHash to the store.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Rollback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ReqHash"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//When Blockchain module fails to generate blocks, the KVSet data corresponding to StateHash's memory will be cleared.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Del")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("types"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StoreDel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//In case of exception, the corresponding KV information of StateHash written to block is rolled back.")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("IterateRangeByStateHash")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("statehash "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" start "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" end "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ascending "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" fn "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("bool")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("////Reserved event handling interface")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ProcEvent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg queue"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Message"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br")])]),s("p",[t._v("The newly added plug-in types of Store layer all need to implement the above interfaces, such as KV DB, KVMVCC DB, MPT, etc.")])])}),[],!1,null,null,null);a.default=n.exports}}]);
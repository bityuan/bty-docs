# web3.jsåˆçº¦äº‹ä»¶

> ğŸ“¹ [è§†é¢‘æ•™ç¨‹](https://www.bilibili.com/video/BV1ok4y187Yo/?share_source=copy_web&vd_source=6dc648c02f2bdc5a6e650dadc1136eed)

äº‹ä»¶æ˜¯Solidityåˆçº¦ä¸­çš„ä¸€ç§é€šä¿¡æœºåˆ¶ï¼Œå®ƒå…è®¸åˆçº¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘å‡ºé€šçŸ¥ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºæˆ–å…¶ä»–åˆçº¦å¯ä»¥ç›‘å¬è¿™äº›é€šçŸ¥å¹¶é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚

äº‹ä»¶é€šå¸¸ç”¨äºä»¥ä¸‹æƒ…å†µï¼š
1. äº¤æ˜“å®Œæˆåå‘å¤–éƒ¨ç³»ç»Ÿå‘é€é€šçŸ¥ã€‚
2. ç›‘å¬åˆçº¦çŠ¶æ€å˜åŒ–ï¼Œä¾‹å¦‚åˆçº¦ä¸­æŸä¸ªå€¼çš„æ›´æ–°ã€‚
3. è®°å½•åˆçº¦çš„è¡Œä¸ºï¼Œä»¥ä¾¿åç»­åˆ†ææˆ–å®¡è®¡ã€‚

ä»¥å‰é¢ä»‹ç»çš„NFTåˆçº¦ä¸ºä¾‹ï¼š
```solidity
event TokenMinted(uint256 indexed tokenId, uint256 supply, string uri);

function mint(uint256 tokenId, uint256 supply, string memory uri) public onlyOwner {
        _mint(msg.sender, tokenId, supply, "");
        _tokenSupply[tokenId] += supply;
        _tokenURIs[tokenId] = uri;
        emit TokenMinted(tokenId, supply, uri);
    }
```
åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼ŒTokenMintedäº‹ä»¶ç”¨äºè®°å½•mintå‡½æ•°ä¸­çš„å€¼æ›´æ”¹ï¼Œå¹¶å‘åº”ç”¨ç¨‹åºå‘å‡ºé€šçŸ¥ã€‚indexedå…³é”®å­—ç”¨äºæŒ‡å®šäº‹ä»¶å‚æ•°åœ¨äº‹ä»¶æ—¥å¿—ä¸­è¿›è¡Œç´¢å¼•ï¼Œè¿™ä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥æ›´è½»æ¾åœ°æœç´¢å’Œè¿‡æ»¤äº‹ä»¶æ—¥å¿—ã€‚

é€šè¿‡ç›‘å¬äº‹ä»¶ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è‡ªåŠ¨æ›´æ–°çŠ¶æ€æˆ–å“åº”åˆçº¦çš„çŠ¶æ€å˜åŒ–ï¼Œè¿™ä½¿å¾—åˆçº¦æ›´åŠ çµæ´»å’Œå¯æ‰©å±•ã€‚

## 1. æŸ¥è¯¢åˆçº¦å†å²äº‹ä»¶

web3.eth.getPastLogs()  
è¿‡æ»¤å™¨å¯¹è±¡ï¼š
- fromBlock: èµ·å§‹åŒºå—ï¼ˆæœ€å°å€¼æ”¯æŒä»1å¼€å§‹ï¼‰
- toBlock: ç»ˆæ­¢åŒºå—ï¼Œ è¿™ä¸ªå‚æ•°ä¸å¸¦ä»£è¡¨ä¸€ç›´åˆ°æœ€å¤§åŒºå—
- address: åˆçº¦åœ°å€
- topics: æ—¥å¿—é¡¹ä¸­çš„ä¸»é¢˜å€¼æ•°ç»„

ç¤ºä¾‹ï¼š 
```javascript
web3.eth.getPastLogs({
    address: contractAddress,
    topics: ['0x30b042f6d29a39b7c10c2dfbd81016db37ea3d11e72ec5764fb0d0f7a1012a3a'],
    fromBlock: 71,
})
.then(console.log);

[
  {
    address: '0x61b35E8804F87589fBb7da3A6B68c563C05Bb2f1',
    topics: [
      '0x30b042f6d29a39b7c10c2dfbd81016db37ea3d11e72ec5764fb0d0f7a1012a3a',
      '0x0000000000000000000000000000000000000000000000000000000000002718'
    ],
    data: '........',
    blockNumber: 79,
    transactionHash: '0xc5bb3cd573e04e5561d262c394218bc3ad3457f6f0aa2f8101464ebb108700fb',
    transactionIndex: 0,
    blockHash: '0x7b0b108c8b55bdefb5edd6a1ce1ec05180f3cd0b58aa373ff88e9682ab694b7a',
    logIndex: 1,
    removed: false,
    id: 'log_bab13c4d'
  }
]
```

## 2. è®¢é˜…åŒºå—é“¾ä¸­çš„æŒ‡å®šäº‹ä»¶

web3.eth.subscribe(type [, options] [, callback]);  
- String - è®¢é˜…ç±»å‹
- Mixed - (å¯é€‰) ä¾èµ–äºè®¢é˜…ç±»å‹çš„å¯é€‰é¢å¤–å‚æ•°
- Function - (å¯é€‰) å¯é€‰çš„å›è°ƒå‡½æ•°ï¼Œå…¶ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºé”™è¯¯å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç»“æœ

```javascript
web3.eth.subscribe('logs', {
    address: contractAddress,
    topics: ['0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62'],
}, function(error, result) {
    if (!error) {
        console.log(result);
    } else {
        console.error(error)
    }
})
.on("connected", subscriptionId => {
    console.log(`Subscribed with ID: ${subscriptionId}`);
  });
```

## 3. æ ¹æ®äº‹ä»¶ç­¾åè®¡ç®—topicsçš„å€¼

```javascript
var eventName = 'TokenMinted(uint256,uint256,string)'
var topic = web3.eth.abi.encodeEventSignature(eventName)
```
